<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hub</title>
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" id="pwa-manifest">

    <style>
        :root {
            --light-blue: #ADD8E6;
            --blue-500: #3b82f6; /* A shade of blue for buttons */
            --black: #000000;
            --white: #FFFFFF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--white);
            color: var(--black);
            margin: 0;
            padding: 0;
        }

        .spinner {
            border-top-color: var(--light-blue);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .button-hover-animation {
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .button-hover-animation:hover {
            transform: scale(1.05);
        }
        .button-hover-animation:active {
            transform: scale(0.95);
        }
        
        .profile-card-animation {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .profile-card-animation:hover {
            transform: scale(1.02);
        }

        /* Custom icons to replace the placeholders */
        .icon-groups {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-referral {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M9.89 19.89l-2.45-2.45c-1.39.77-2.91 1.05-4.45.83l-1.07 4.28c-.28 1.13.56 2.19 1.7 1.91l4.28-1.07c1.47-2.3 2.5-4.99 3.02-7.85zm12.92-12.92c-.39-.39-1.02-.39-1.41 0l-1.32 1.32c-1.28-1.05-2.82-1.73-4.44-2.02l-.65-4.01c-.19-1.16-.95-2.13-2.08-2.34-1.12-.22-2.1.52-2.29 1.63l-.65 4.01c-1.62.29-3.16.97-4.44 2.02l-1.32-1.32c-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41l1.32 1.32c-.89 1.54-1.42 3.2-1.6 4.93l-4.01.65c-1.16.19-2.13.95-2.34 2.08-1.16 5.86 1.7 10.7 7.02 12.06.4.1.84.14 1.25.14s.85-.04 1.25-.14c5.32-1.36 8.18-6.2 7.02-12.06-.21-1.13-.97-1.89-2.08-2.08l-4.01-.65c.29-1.62.97-3.16 2.02-4.44l1.32 1.32c.39.39 1.02.39 1.41 0l1.41-1.41zM20 18c-3.7 0-6.75-3.05-6.75-6.75s3.05-6.75 6.75-6.75 6.75 3.05 6.75 6.75-3.05 6.75-6.75 6.75zm.7-11.41c-.2-.2-.52-.2-.71 0l-3.3 3.3c-.2.2-.2.52 0 .71l.71.71c.2.2.52.2.71 0l3.3-3.3c.2-.2.2-.52 0-.71l-.71-.71z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-profile {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-signout {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M13 3h-2v10h2V3zm-2 16h2v-2h-2v2zm6.78-9.22l1.41-1.41c.39-.39.39-1.02 0-1.41l-2.45-2.45c-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41l2.45 2.45c.39.39 1.02.39 1.41 0zM5.22 8.78l-1.41-1.41c-.39-.39-.39-1.02 0-1.41l2.45-2.45c.39-.39 1.02-.39 1.41 0l1.41 1.41c.39.39.39 1.02 0 1.41l-2.45 2.45c-.39.39-1.02.39-1.41 0z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-copy {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-share {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M18 16.08c-.76 0-1.44.3-1.96.79l-4.1-2.05c.09-.23.16-.48.16-.74 0-.26-.07-.51-.16-.74l4.1-2.05c.52.49 1.2.79 1.96.79 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .26.07.51.16.74l-4.1 2.05c-.52-.49-1.2-.79-1.96-.79-1.66 0-3 1.34-3 3s1.34 3 3 3c.76 0 1.44-.3.16-.74l4.1 2.05c-.09.23-.16.48-.16.74 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3zm-15 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm13 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-close {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
        .icon-check {
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E") no-repeat center;
            background-color: currentColor;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- The main container where the app content will be rendered -->
    <main id="app-container" class="flex-grow flex items-center justify-center p-4"></main>

    <!-- Navigation Bar -->
    <nav id="nav-bar" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-10 p-2 shadow-lg hidden">
        <ul class="flex justify-around items-center">
            <li>
                <button id="nav-home" class="flex flex-col items-center p-2 rounded-lg transition-colors text-blue-500 bg-blue-50">
                    <div class="icon-groups w-6 h-6"></div>
                    <span class="text-xs mt-1">Discover</span>
                </button>
            </li>
            <li>
                <button id="nav-referral" class="flex flex-col items-center p-2 rounded-lg transition-colors text-gray-500 hover:text-blue-500">
                    <div class="icon-referral w-6 h-6"></div>
                    <span class="text-xs mt-1">Referral</span>
                </button>
            </li>
            <li>
                <button id="nav-profile" class="flex flex-col items-center p-2 rounded-lg transition-colors text-gray-500 hover:text-blue-500">
                    <div class="icon-profile w-6 h-6"></div>
                    <span class="text-xs mt-1">Profile</span>
                </button>
            </li>
            <li>
                <button id="nav-signout" class="flex flex-col items-center p-2 rounded-lg transition-colors text-red-500 hover:bg-red-50">
                    <div class="icon-signout w-6 h-6"></div>
                    <span class="text-xs mt-1">Sign Out</span>
                </button>
            </li>
        </ul>
    </nav>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Client Setup ---
        // IMPORTANT: Replace with your Supabase project URL and public key.
        // You can find these in your Supabase dashboard under Settings > API.
        const supabaseUrl = 'https://iwszexjvrgsmhxzfciok.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3c3pleGp2cmdzbWh4emZjaW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyMDg1MTEsImV4cCI6MjA2OTc4NDUxMX0.bgZZvP_pFR_BTG13M5-Q13G2-N-tV82lB2EmY9EYZMQ';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- Global State ---
        let state = {
            session: null,
            userData: null,
            currentPage: 'home',
            profiles: [],
            currentProfileIndex: 0,
            loading: true,
            isSignUp: false,
            message: ''
        };

        const appContainer = document.getElementById('app-container');
        const navBar = document.getElementById('nav-bar');

        // --- PWA Setup ---
        const manifestContent = {
            name: "The Hub",
            short_name: "The Hub",
            description: "Connect with students at your university.",
            start_url: "/",
            display: "standalone",
            background_color: "#FFFFFF",
            theme_color: "#ADD8E6",
            icons: [
                {
                    src: "https://placehold.co/192x192/ADD8E6/000000?text=Hub",
                    sizes: "192x192",
                    type: "image/png"
                },
                {
                    src: "https://placehold.co/512x512/ADD8E6/000000?text=Hub",
                    sizes: "512x512",
                    type: "image/png"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.getElementById('pwa-manifest').href = manifestUrl;

        // --- Service Worker Script (Data URL) ---
        const serviceWorkerCode = `
        const CACHE_NAME = 'the-hub-cache-v1';
        const urlsToCache = [
            '/',
            '/index.html',
            // Add other critical assets like images, fonts here
            'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm',
            'https://cdn.tailwindcss.com'
        ];

        self.addEventListener('install', (event) => {
            event.waitUntil(
                caches.open(CACHE_NAME)
                    .then((cache) => cache.addAll(urlsToCache))
            );
        });

        self.addEventListener('fetch', (event) => {
            event.respondWith(
                caches.match(event.request)
                    .then((response) => {
                        if (response) {
                            return response;
                        }
                        return fetch(event.request);
                    })
            );
        });
        `;
        const serviceWorkerBlob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
        const serviceWorkerUrl = URL.createObjectURL(serviceWorkerBlob);
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(serviceWorkerUrl)
                    .then(registration => console.log('SW registered:', registration))
                    .catch(error => console.log('SW registration failed:', error));
            });
        }
        
        // --- Rendering Functions ---
        const render = async () => {
            if (state.loading) {
                appContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen">
                        <div class="spinner w-32 h-32 rounded-full border-t-4 border-b-4 border-gray-200"></div>
                        <p class="mt-4 text-gray-600">Loading...</p>
                    </div>
                `;
                return;
            }

            if (!state.session) {
                renderAuth();
            } else if (!state.userData?.is_verified) {
                renderUnverifiedPage();
            } else {
                navBar.classList.remove('hidden');
                switch (state.currentPage) {
                    case 'home':
                        renderSwipingPage();
                        break;
                    case 'referral':
                        renderReferralPage();
                        break;
                    case 'profile':
                        renderProfilePage();
                        break;
                    default:
                        renderSwipingPage();
                }
            }
        };

        const renderAuth = () => {
            appContainer.innerHTML = `
                <div class="fade-in w-full max-w-md p-8 space-y-6 bg-gray-50 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-3xl font-bold text-center text-blue-500">Welcome to The Hub</h2>
                    <p class="text-center text-gray-600">${state.isSignUp ? 'Create your account' : 'Sign in to continue'}</p>
                    <form id="auth-form" class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email-input" required class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password-input" required class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                        </div>
                        ${state.isSignUp ? `
                        <div>
                            <label class="text-sm font-medium text-gray-700">Referral Code</label>
                            <input type="text" id="referral-input" required class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition"/>
                        </div>` : ''}
                        <button type="submit" id="auth-button" class="w-full py-2 px-4 rounded-md text-white font-bold bg-blue-500 hover:bg-blue-600 transition-colors button-hover-animation">
                            ${state.isSignUp ? 'Sign Up' : 'Sign In'}
                        </button>
                    </form>
                    ${state.message ? `
                    <div class="mt-4 p-3 bg-red-100 text-red-700 rounded-md text-center">
                        ${state.message}
                    </div>` : ''}
                    <button id="toggle-auth-mode" class="w-full text-center text-sm font-medium text-blue-500 hover:underline transition">
                        ${state.isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign Up"}
                    </button>
                </div>
            `;
            // Attach event listeners
            document.getElementById('auth-form').addEventListener('submit', handleAuth);
            document.getElementById('toggle-auth-mode').addEventListener('click', () => {
                state.isSignUp = !state.isSignUp;
                state.message = '';
                render();
            });
        };

        const renderUnverifiedPage = () => {
             appContainer.innerHTML = `
                <div class="fade-in w-full max-w-md p-8 space-y-6 bg-gray-50 rounded-xl shadow-lg border border-gray-200 text-center">
                    <h2 class="text-3xl font-bold text-black">Account Not Verified</h2>
                    <p class="text-gray-700">
                        You need a valid referral code to access The Hub.
                    </p>
                    <p class="text-sm text-gray-500">
                        Please contact a friend who is already a member for their code, or sign out and try again with a valid code.
                    </p>
                    <button id="signout-button" class="mt-4 w-full py-2 px-4 rounded-md text-white font-bold bg-red-500 hover:bg-red-600 transition-colors button-hover-animation">
                        Sign Out
                    </button>
                </div>
            `;
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
        };

        const renderSwipingPage = async () => {
            const currentProfile = state.profiles[state.currentProfileIndex];

            appContainer.innerHTML = `
                <div id="profile-card" class="fade-in w-full max-w-sm bg-gray-50 rounded-xl shadow-lg border border-gray-200 overflow-hidden profile-card-animation">
                    <div class="p-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                                <div class="icon-profile w-10 h-10"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-black">${currentProfile.full_name || 'Anonymous User'}</h3>
                                <p class="text-sm text-gray-500">${currentProfile.major || 'Major not specified'}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-gray-700">${currentProfile.bio || 'Bio not yet added.'}</p>
                    </div>
                </div>

                <div class="flex space-x-8 mt-8">
                    <button id="pass-button" class="p-4 bg-white text-gray-400 border border-gray-300 rounded-full shadow-md transition-transform transform hover:scale-110 active:scale-95 button-hover-animation" aria-label="Pass">
                        <div class="icon-close w-8 h-8"></div>
                    </button>
                    <button id="like-button" class="p-4 bg-blue-500 text-white border border-blue-500 rounded-full shadow-md transition-transform transform hover:scale-110 active:scale-95 button-hover-animation" aria-label="Like">
                        <div class="icon-check w-8 h-8"></div>
                    </button>
                </div>
            `;
            document.getElementById('pass-button').addEventListener('click', () => handleSwipe(false));
            document.getElementById('like-button').addEventListener('click', () => handleSwipe(true));
        };

        const renderReferralPage = () => {
            appContainer.innerHTML = `
                <div class="fade-in w-full max-w-md p-8 space-y-6 bg-gray-50 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold text-center text-black">My Referral Code</h2>
                    <div id="referral-code-display" class="p-4 bg-white border border-dashed border-light-blue rounded-md text-center text-2xl font-bold text-blue-500">
                        ${state.userData?.referral_code || 'Loading...'}
                    </div>
                    <div class="flex flex-col space-y-4">
                        <button id="copy-button" class="w-full py-2 px-4 rounded-md text-white font-bold bg-blue-500 hover:bg-blue-600 transition-colors button-hover-animation">
                            <div class="icon-copy w-6 h-6 inline-block mr-2"></div>
                            Copy Code
                        </button>
                        <button id="share-button" class="w-full py-2 px-4 rounded-md text-white font-bold bg-light-blue hover:bg-blue-400 transition-colors button-hover-animation">
                            <div class="icon-share w-6 h-6 inline-block mr-2"></div>
                            Share App
                        </button>
                    </div>
                    ${state.message ? `<p id="referral-message" class="text-center text-sm text-green-600">${state.message}</p>` : ''}
                </div>
            `;
            document.getElementById('copy-button').addEventListener('click', handleCopyCode);
            document.getElementById('share-button').addEventListener('click', handleShare);
        };
        
        const renderProfilePage = () => {
            appContainer.innerHTML = `
                <div class="fade-in w-full max-w-md p-8 space-y-6 bg-gray-50 rounded-xl shadow-lg border border-gray-200 text-center">
                    <h2 class="text-3xl font-bold text-black">Profile Page</h2>
                    <p class="text-gray-700">This is your profile page. More features coming soon!</p>
                    <p class="text-sm text-gray-500">Your User ID: ${state.session.user.id}</p>
                </div>
            `;
        };

        // --- Event Handlers ---
        const handleAuth = async (event) => {
            event.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const referralCode = document.getElementById('referral-input')?.value;
            
            state.loading = true;
            render();

            if (state.isSignUp) {
                if (!referralCode) {
                    state.message = 'Please enter a referral code.';
                    state.loading = false;
                    render();
                    return;
                }
                try {
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: { data: { referral_code: referralCode } }
                    });
                    if (error) throw error;
                    state.message = 'Check your email for the verification link!';
                    state.session = data.user;
                } catch (error) {
                    state.message = error.message;
                }
            } else {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    state.session = data.user;
                } catch (error) {
                    state.message = error.message;
                }
            }
            state.loading = false;
            render();
        };

        const handleSignOut = async () => {
            await supabase.auth.signOut();
            state.session = null;
            state.userData = null;
            state.currentPage = 'home';
            navBar.classList.add('hidden');
            render();
        };

        const handleSwipe = (isMatch) => {
            if (isMatch) {
                console.log(`Matched with profile ${state.profiles[state.currentProfileIndex].id}`);
            }
            state.currentProfileIndex++;
            if (state.currentProfileIndex >= state.profiles.length) {
                state.currentProfileIndex = 0;
            }
            renderSwipingPage();
        };

        const handleCopyCode = () => {
            const code = state.userData?.referral_code;
            if (code) {
                navigator.clipboard.writeText(code)
                    .then(() => {
                        state.message = 'Referral code copied!';
                        renderReferralPage();
                    })
                    .catch(() => {
                        state.message = 'Failed to copy. Please copy manually.';
                        renderReferralPage();
                    });
            }
        };
        
        const handleShare = () => {
            const code = state.userData?.referral_code;
            if (navigator.share && code) {
                navigator.share({
                    title: 'The Hub',
                    text: `Join The Hub, the exclusive dating app for college students! Use my referral code to get verified: ${code}`,
                    url: window.location.origin,
                }).catch(error => console.log('Error sharing:', error));
            } else {
                handleCopyCode();
            }
        };

        // --- Core Application Logic ---
        const init = async () => {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                state.session = session;
            } catch (error) {
                console.error('Error fetching session:', error);
            }
            state.loading = false;
            await fetchUserData();
        };

        const fetchUserData = async () => {
            if (!state.session) {
                state.userData = null;
                render();
                return;
            }
            state.loading = true;
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', state.session.user.id)
                .single();
            if (error) {
                console.error('Error fetching user data:', error);
                state.userData = null;
            } else {
                state.userData = data;
            }
            state.loading = false;
            render();
        };

        // Event listener for navigation buttons
        document.getElementById('nav-home').addEventListener('click', () => {
            state.currentPage = 'home';
            render();
        });
        document.getElementById('nav-referral').addEventListener('click', () => {
            state.currentPage = 'referral';
            render();
        });
        document.getElementById('nav-profile').addEventListener('click', () => {
            state.currentPage = 'profile';
            render();
        });
        document.getElementById('nav-signout').addEventListener('click', handleSignOut);

        // Initial render on page load
        window.addEventListener('load', init);

        // Handle URL changes to update app state
        window.onpopstate = () => {
            state.currentPage = 'home'; // Simple state management for history
            render();
        };

    </script>
</body>
</html>
